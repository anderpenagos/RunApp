name: Release Build e Telegram

on:
  push:
    tags:
      - 'v*'  # Executa quando criar uma tag como v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Nome da versÃ£o (ex: 1.0.0)'
        required: true

jobs:
  release:
    name: Build Release e Enviar
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Baixar gradle-wrapper.jar
        run: |
          mkdir -p gradle/wrapper
          curl -L \
            "https://github.com/gradle/gradle/raw/v8.7.0/gradle/wrapper/gradle-wrapper.jar" \
            -o gradle/wrapper/gradle-wrapper.jar
      
      - name: Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
      
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace
        env:
          MAPS_API_KEY: ${{ secrets.MAPS_API_KEY }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      
      - name: Get version info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "name=$VERSION" >> $GITHUB_OUTPUT
          
          VERSION_CODE=$(grep -oP 'versionCode = \K[0-9]+' app/build.gradle.kts)
          echo "code=$VERSION_CODE" >> $GITHUB_OUTPUT
          
          # InformaÃ§Ãµes do release
          if [ "${{ github.event_name }}" == "push" ]; then
            TAG_MSG=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
            echo "tag_msg=$TAG_MSG" >> $GITHUB_OUTPUT
          fi
      
      - name: Rename APK
        run: |
          mkdir -p release
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            cp app/build/outputs/apk/release/app-release.apk release/RunApp-v${{ steps.version.outputs.name }}-signed.apk
            echo "APK_TYPE=signed" >> $GITHUB_ENV
          elif [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            cp app/build/outputs/apk/release/app-release-unsigned.apk release/RunApp-v${{ steps.version.outputs.name }}-unsigned.apk
            echo "APK_TYPE=unsigned" >> $GITHUB_ENV
          else
            echo "APK file not found!"
            ls -la app/build/outputs/apk/release/
            exit 1
          fi
      
      - name: Enviar Release para Telegram
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Nome do arquivo
          if [ "$APK_TYPE" == "signed" ]; then
            APK_FILE="release/RunApp-v${{ steps.version.outputs.name }}-signed.apk"
            APK_STATUS="âœ… Assinado"
          else
            APK_FILE="release/RunApp-v${{ steps.version.outputs.name }}-unsigned.apk"
            APK_STATUS="âš ï¸ NÃ£o assinado"
          fi
          
          # Mensagem formatada para release
          MESSAGE="ðŸŽ‰ *RunApp - Nova Release*%0A%0A"
          MESSAGE="${MESSAGE}ðŸ“± *VersÃ£o:* ${{ steps.version.outputs.name }}%0A"
          MESSAGE="${MESSAGE}ðŸ”¢ *Build:* ${{ steps.version.outputs.code }}%0A"
          MESSAGE="${MESSAGE}ðŸ“¦ *Status:* $APK_STATUS%0A"
          MESSAGE="${MESSAGE}ðŸ“… *Data:* $(date '+%d/%m/%Y %H:%M')%0A"
          MESSAGE="${MESSAGE}ðŸ”— *Tag:* \`${{ github.ref_name }}\`%0A%0A"
          
          if [ ! -z "${{ steps.version.outputs.tag_msg }}" ]; then
            MESSAGE="${MESSAGE}ðŸ“ *Release Notes:*%0A${{ steps.version.outputs.tag_msg }}%0A%0A"
          fi
          
          MESSAGE="${MESSAGE}â¬‡ï¸ *Baixe o APK acima para instalar*"
          
          # Envia o arquivo para o Telegram
          curl -F "chat_id=$TELEGRAM_CHAT_ID" \
               -F "document=@$APK_FILE" \
               -F "caption=$MESSAGE" \
               -F "parse_mode=Markdown" \
               "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument"
      
      - name: Create GitHub Release
        if: success() && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.apk
          body: |
            ## ðŸŽ‰ RunApp v${{ steps.version.outputs.name }}
            
            ### ðŸ“± InstalaÃ§Ã£o
            1. Baixe o arquivo APK abaixo
            2. Permita instalaÃ§Ã£o de fontes desconhecidas no seu Android
            3. Execute o APK baixado
            
            ### ðŸ“ Changelog
            ${{ steps.version.outputs.tag_msg }}
            
            ### â„¹ï¸ InformaÃ§Ãµes
            - **Version Code:** ${{ steps.version.outputs.code }}
            - **Build Date:** $(date '+%d/%m/%Y %H:%M')
            - **Commit:** ${{ github.sha }}
            - **Status:** ${{ env.APK_TYPE == 'signed' && 'Assinado âœ…' || 'NÃ£o assinado âš ï¸' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Notificar erro no Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="âŒ *RunApp - Release Falhou*%0A%0A"
          MESSAGE="${MESSAGE}ðŸ“± *VersÃ£o:* ${{ steps.version.outputs.name }}%0A"
          MESSAGE="${MESSAGE}ðŸ“… *Data:* $(date '+%d/%m/%Y %H:%M')%0A%0A"
          MESSAGE="${MESSAGE}ðŸ” Verifique os logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\"}" \
               "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
      
      - name: Create Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## ðŸŽ‰ Release Build Completo!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **APK enviado para o Telegram!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Release Build Falhou!" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± InformaÃ§Ãµes da Release" >> $GITHUB_STEP_SUMMARY
          echo "- **VersÃ£o:** ${{ steps.version.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code:** ${{ steps.version.outputs.code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** $APK_TYPE" >> $GITHUB_STEP_SUMMARY
